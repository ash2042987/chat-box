<!-- IMPORTS -->
<!-- POLYMER -->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<!-- APP ELEMENTS -->
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<!-- PAPER ELEMENTS -->
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<!-- IRON ELEMENTS -->
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<!-- POLYMERFIRE ELEMENTS -->
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<!-- CUSTOM ELEMENTS -->
<link rel="import" href="../ceg-icons/ceg-icons.html">
<!-- STYLES -->
<link rel="import" href="../ceg-styles/shared-styles.html">
<link rel="import" href="../ceg-styles/chat-styles.html">


<dom-module id="ceg-chat">
  <template>
    <style include="shared-styles"></style>
    <style include="chat-styles"></style>

    <!-- FIREBASE QUERY -->
    <firebase-query
      id="query"
      path="/[[selectedThread]]/messages"
      data="{{messages}}"
    ></firebase-query>

    <!-- CHAT-BOX -->
      <div id="chat-box">
        <!-- THREAD LIST CONTAINER -->
        <div id="thread-list">

          <div id="thread-userbox">
            <h2>Welcome [[userName]]!</h2>
            <img src="[[userImage]]" alt="[[userName]]'s Profile Image'">
          </div>

          <div id="thread-bar">
            <h3>Threads</h3>
          </div>

          <div id="thread-options">

            <iron-selector attr-for-selected="name" selected="[[selectedThread]]">

              <div name="General" class="thread-option" on-tap="threadChange">
                <iron-icon icon="ceg-icons:people"></iron-icon>
                General
              </div>

              <div name="Comments" class="thread-option" on-tap="threadChange">
                <iron-icon icon="ceg-icons:comment"></iron-icon>
                Comments
              </div>

              <div name="Feedback" class="thread-option" on-tap="threadChange">
                <iron-icon icon="ceg-icons:feedback"></iron-icon>
                Feedback
              </div>
            </iron-selector>

          </div>

        </div>

        <div id="messages">

          <app-toolbar>
            <div main-title>Chat-Box - [[selectedThread]]</div>
            <!-- DRAWER ICON -->
            <paper-icon-button id="drawer-button" on-tap="_toggleDrawer" icon="ceg-icons:menu"></paper-icon-button>
            <!-- SIGN OUT ICON -->
            <paper-icon-button id="signout-button" on-tap="_signOut" icon="ceg-icons:backspace"></paper-icon-button>
            <paper-tooltip for="signout-button" offset="0">Sign Out</paper-tooltip>
          </app-toolbar>

          <div id="message-body">
            <template is="dom-repeat" items="{{messages}}" as="message">

              <div class="message">
                <img src="[[message.image]]" alt="[[message.user]]'s' Profile Image">
                <p style="font-size: 1.3em">[[message.user]]</p>
                <p class="message-text">[[message.content]]</p>
              </div>

            </template>
          </div>

          <div id="message-input">
            <paper-textarea id="user-message" on-keyup="checkKey"></paper-textarea>
              <paper-button on-tap="addMessage">
                <iron-icon icon="ceg-icons:send"></iron-icon>
              </paper-button>
          </div>

        </div>

      </div><!-- CHAT BOX DIV END -->

      <!-- DRAWER -->
      <app-drawer id="drawer" align="right" slot="drawer">
        <div id="thread-userbox">
          <h2>Welcome [[userName]]!</h2>
          <img src="[[userImage]]" alt="[[userName]]'s Profile Image'">
        </div>

        <div id="thread-bar">
          <h3>Threads</h3>
        </div>

        <iron-selector attr-for-selected="name" selected="[[selectedThread]]">

          <div name="General" class="thread-option" on-tap="threadChange">
            <iron-icon icon="ceg-icons:people"></iron-icon>
            General
          </div>

          <div name="Comments" class="thread-option" on-tap="threadChange">
            <iron-icon icon="ceg-icons:comment"></iron-icon>
            Comments
          </div>

          <div name="Feedback" class="thread-option" on-tap="threadChange">
            <iron-icon icon="ceg-icons:feedback"></iron-icon>
            Feedback
          </div>

          <div class="thread-option" on-tap="_signOut">
            <iron-icon icon="ceg-icons:arrow-back"></iron-icon>
            Sign Out
          </div>
        </iron-selector>
      </app-drawer>

  </template>

  <script>
    class CegmagChat extends Polymer.LegacyElementMixin(Polymer.Element) {

      constructor(){
        super();
      }

      connectedCallback(){
        super.connectedCallback();
        this._adjustScrollHeight();
      }

      static get is() { return 'ceg-chat'; }

      static get properties() {

        return {
          selectedThread: {
            type: String,
            observer: "_onThreadChange"
          },
          messages: {
            type: Object
            //observer: "_dataChanged"
          },
          userName: String,
          userImage: String
        }

      }

      threadChange(e) {
        if(e.currentTarget.textContent.replace(/\s+/g, '') === this.selectedThread){
          return false;
        }

        this._adjustScrollHeight();
        this.selectedThread = e.currentTarget.textContent.replace(/\s+/g, '');

        if (!this.$.drawer.persistent) {
          this.$.drawer.close();
        }
      }

      _onThreadChange(){
        console.log('hello');
      }

      addMessage() {
        this.$.query.ref.push({
          image: this.userImage,
          content: this.$["user-message"].value,
          user: this.userName
        });

        this.$["user-message"].value = null;
      }

      checkKey(e) {
        if(e.keyCode === 13 || e.charCode === 13) {
          this.addMessage();
        }
      }

      _adjustScrollHeight(){
        console.log("adjusted");
        var messageBody = this.$['message-body'];
        messageBody.scrollTop = messageBody.scrollHeight;
      }

      _toggleDrawer(){
        this.$.drawer.toggle();
      }

      _signOut(){
        window.dispatchEvent(new CustomEvent('sign-out'))
      }
    }


    window.customElements.define(CegmagChat.is, CegmagChat);
  </script>
</dom-module>
