<!-- IMPORTS -->
<!-- POLYMER -->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<!-- APP ELEMENTS -->
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<!-- PAPER ELEMENTS -->
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<!-- IRON ELEMENTS -->
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<!-- POLYMERFIRE ELEMENTS -->
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">
<!-- CUSTOM ELEMENTS -->
<link rel="import" href="../ceg-icons/ceg-icons.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="ceg-chat">
  <template>
    <style include="shared-styles">
      #chat-box {
        width: 100%;
        background-color: #ffffff;
        overflow: hidden;
        height: 100vh;
      }
      #thread-list {
        width: 29.85%;
        float: left;
        height: 100%;
        background-color: white;
        border-right: 1px solid #2ECC71;
      }
        #thread-userbox {
          background-color: #2ECC71;
          color: white;
          display: flex;
          flex-direction: column;
        }
          #thread-userbox h2 {
            margin: 0;
            padding: 10px 0;
            font-size: 2.2em;
            text-align: center;
          }
          #thread-userbox img {
            width: 100px;
            border-radius: 50%;
            display: flex;
            align-self: center;
            padding-bottom: 10px;
          }
        #thread-bar {
          background-color: #ffffff;
          color: black;
          border-top: 1px solid #ccc;
          border-bottom: 1px solid #ccc;
          padding: 15px;
          text-align: center;
        }
        .thread-option {
          margin-bottom: 15px;
          font-size: 1.8em;
          padding: 5px;
          text-align: center;
          cursor: pointer;
        }
          .iron-selected {
            background-color: #2ECC71;
            color: white;
          }

      #messages {
        width: 70%;
        float: right;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background-color: #eee;
      }
        #messages app-toolbar {
          background-color: #2ECC71;
          color: white;
        }
        #drawer-button {
          visibility: hidden;
        }
      #message-body{
        display: flex;
        flex-direction: column;
        overflow-x: hidden;
        overflow-y: auto;
        height: calc(100vh - 100px);
      }
        #message-body img {
          width: 50px;
          border-radius: 50%;
        }
        #message-body p {
          font-size: 1.6em;
          margin: 0;
        }
      .left-message {
        clear:both;
        width: 100%;
        padding: 5px 0 10px 0;
        border-bottom: 1px solid #ccc;
      }
        .left-message img {
          margin: 10px 25px 10px 15px;
          max-width: 15%;
          float: left;
        }
        .text-left {
          max-width: 75%;
          float: left;
          position: relative;
          background: #ccc;
          padding: 10px;
          color: #222;
          border-radius: 3px;
          margin-bottom: 15px;
        }
        .text-left::after {
          content: "";
          display: block;
          position: absolute;
          width: 0;
          height: 0;
          border-top: 8px solid transparent;
          border-bottom: 8px solid transparent;
          border-right: 15px solid #ccc;
          left: -11px;
          bottom: 25px;
        }
      .right-message {
        clear: both;
        width: 100%;
        padding: 5px 0 10px 0;
        text-align: right;
        border-bottom: 1px solid #ccc;
      }
        .right-message img {
          margin: 10px 10px 10px 25px;
          max-width: 15%;
          float: right;
        }
        .text-right {
          max-width: 75%;
          float: right;
          position: relative;
          background: #2ECC71;
          padding: 10px;
          color: #ffffff;
          border-radius: 3px;
          margin-bottom: 15px;
        }
          .text-right::after {
            content: "";
            display: block;
            position: absolute;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 15px solid  #2ECC71;
            right: -11px;
            bottom: 25px;
          }

      #message-input {
        height: 100px;
        display: flex;
        border-top: 1px solid #ccc;
      }
      #message-input paper-textarea{
        width: 90%;
        overflow: auto;
        float: left;
        margin-left: 2px;
        margin-top: 15px;
      }
      #message-input paper-button {
        border-radius: 50%;
        height: 70px;
        padding: 25px;
        margin-top: 20px;
        margin-left: 5px;
        color: white;
        background-color: #2ECC71;
      }

      @media screen and (max-width: 760px) {
        #thread-list {
          display: none;
        }
        #messages{
          width: 100%;
          display: flex;
          flex-direction: column;
        }
          #drawer-button {
            visibility: visible;
          }
          #signout-button {
            display: none;
          }
      }

    /* MESSAGE BODY MEDIA QUERIES */
    @media screen and (max-width: 475px) {
      .right-message, .left-message {
        padding: 5px 0 10px 0;
      }
      .right-message img, .left-message img {
        margin: 0;
      }
        .left-message img {
          margin-right: 15px;
        }
        .right-message img {
          margin-left: 15px;
        }
      .text-right::after, .text-left::after {
        display: none;
      }

      #message-input paper-button {
        height: 25px;
        margin-top: 25px;
      }
    }

    </style>

    <!-- FIREBASE QUERY -->
    <firebase-query
      id="query"
      path="/[[selectedThread]]/messages"
      data="{{messages}}"
    ></firebase-query>

    <!-- CHAT-BOX -->
      <div id="chat-box">
        <!-- THREAD LIST CONTAINER -->
        <div id="thread-list">

          <div id="thread-userbox">
            <h2>Welcome [[userName]]!</h2>
            <img src="[[userImage]]" alt="[[userName]]'s Profile Image'">
          </div>

          <div id="thread-bar">
            <h3>Threads</h3>
          </div>

          <div id="thread-options">

            <iron-selector attr-for-selected="name" selected="[[selectedThread]]">

              <div name="General" class="thread-option" on-tap="threadChange">
                <iron-icon icon="ceg-icons:people"></iron-icon>
                General
              </div>

              <div name="Comments" class="thread-option" on-tap="threadChange">
                <iron-icon icon="ceg-icons:comment"></iron-icon>
                Comments
              </div>

              <div name="Feedback" class="thread-option" on-tap="threadChange">
                <iron-icon icon="ceg-icons:feedback"></iron-icon>
                Feedback
              </div>
            </iron-selector>

          </div>

        </div>

        <div id="messages">

          <app-toolbar>
            <div main-title>Chat-Box - [[selectedThread]]</div>
            <!-- DRAWER ICON -->
            <paper-icon-button id="drawer-button" on-tap="_toggleDrawer" icon="ceg-icons:menu"></paper-icon-button>
            <!-- SIGN OUT ICON -->
            <paper-icon-button id="signout-button" on-tap="_signOut" icon="ceg-icons:backspace"></paper-icon-button>
            <paper-tooltip for="signout-button" offset="0">Sign Out</paper-tooltip>
          </app-toolbar>

          <div id="message-body">
            <template is="dom-repeat" items="{{messages}}" as="message">

                <template is="dom-if" if="[[isOnlineUser([[userName]], message.user)]]">
                  <div class="right-message">
                    <img src="[[message.image]]" "[[message.user]]'s' Profile Image">
                    <p class="name-right">[[message.user]]</p>
                    <p class="text-right">[[message.content]]</p>
                  </div>
                </template>

                <template is="dom-if" if="[[isOtherUser([[userName]], message.user)]]">
                  <div class="left-message">
                    <img src="[[message.image]]" alt="[[message.user]]'s' Profile Image">
                    <p class="name-left">[[message.user]]</p>
                    <p class="text-left">[[message.content]]</p>
                  </div>
                </template>

              </template>
          </div>

          <div id="message-input">
            <paper-textarea id="user-message"></paper-textarea>
              <paper-button on-tap="addMessage">
                <iron-icon icon="ceg-icons:send"></iron-icon>
              </paper-button>
          </div>

        </div>

      </div><!-- CHAT BOX DIV END -->

      <!-- DRAWER -->
      <app-drawer id="drawer" align="right" slot="drawer">
        <div id="thread-userbox">
          <h2>Welcome [[userName]]!</h2>
          <img src="[[userImage]]" alt="[[userName]]'s Profile Image'">
        </div>

        <div id="thread-bar">
          <h3>Threads</h3>
        </div>

        <iron-selector attr-for-selected="name" selected="[[selectedThread]]">

          <div name="General" class="thread-option" on-tap="threadChange">
            <iron-icon icon="ceg-icons:people"></iron-icon>
            General
          </div>

          <div name="Comments" class="thread-option" on-tap="threadChange">
            <iron-icon icon="ceg-icons:comment"></iron-icon>
            Comments
          </div>

          <div name="Feedback" class="thread-option" on-tap="threadChange">
            <iron-icon icon="ceg-icons:feedback"></iron-icon>
            Feedback
          </div>

          <div class="thread-option" on-tap="_signOut">
            <iron-icon icon="ceg-icons:arrow-back"></iron-icon>
            Sign Out
          </div>
        </iron-selector>
      </app-drawer>

  </template>

  <script>
    class CegmagChat extends Polymer.LegacyElementMixin(Polymer.Element) {

      constructor(){
        super();
      }
      connectedCallback(){
        super.connectedCallback();
        this._adjustScrollHeight();
      }


      static get is() { return 'ceg-chat'; }

      static get properties() {

        return {
          selectedThread: {
            type: String,
            value: "General",
            observer: "_onThreadChange"
          },
          messages: {
            type: Object
            //observer: "_dataChanged"
          },
          userName: String,
          userImage: String
        }

      }

      threadChange(e) {
        if(e.currentTarget.textContent.replace(/\s+/g, '') === this.selectedThread){
          return false;
        }

        this._adjustScrollHeight();
        this.selectedThread = e.currentTarget.textContent.replace(/\s+/g, '');

        if (!this.$.drawer.persistent) {
          this.$.drawer.close();
        }
      }

      _onThreadChange(){
        console.log('hello');
      }

      addMessage() {
        this.$.query.ref.push({
          image: this.userImage,
          content: this.$["user-message"].value,
          user: this.userName
        });

        this.$["user-message"].value = null;
      }

      isOnlineUser(activeUser, postUser){
        return activeUser === postUser;
      }

      isOtherUser(activeUser, postUser){
        return activeUser !== postUser;
      }

      _adjustScrollHeight(){
        var messageBody = this.$['message-body'];
        messageBody.scrollTop = messageBody.scrollHeight;
      }

      _toggleDrawer(){
        this.$.drawer.toggle();
      }

      _signOut(){
        window.dispatchEvent(new CustomEvent('sign-out'))
      }
    }


    window.customElements.define(CegmagChat.is, CegmagChat);
  </script>
</dom-module>
